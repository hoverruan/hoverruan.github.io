<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Config Redis Replication on Centos 5 | HoverR&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="安装 Redis 2.6.14 CentOS 5.4 Redis 2.6.14 下载并安装：
$ wget http://redis.googlecode.com/files/redis-2.6.14.tar.gz $ cd redis-2.6.14 $ make $ sudo make install CentOS 5自带的Tcl版本是8.4，Redis的make test需要用到Tcl 8.5以上的版本，如果你需要运行测试用例，请先安装新版本的Tcl，然后再安装Redis：
$ wget http://prdownloads.sourceforge.net/tcl/tcl8.6.0-src.tar.gz $ tar xzvf tcl8.6.0-src.tar.gz $ cd tcl8.6.0/unix $ ./configure $ make $ make test $ sudo make install 配置 Redis 服务 修复安装脚本 utils/install_server.sh 的问题 这个版本的安装脚本有一个小问题，请看 #909 Pull Request:
@@ -159,7 &#43;159,7 @@ REDIS_CHKCONFIG_INFO=\ # Description: Redis daemon\n ### END INIT INFO\n\n&#34; -if [ !">
    <meta name="generator" content="Hugo 0.107.0">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Config Redis Replication on Centos 5" />
<meta property="og:description" content="安装 Redis 2.6.14 CentOS 5.4 Redis 2.6.14 下载并安装：
$ wget http://redis.googlecode.com/files/redis-2.6.14.tar.gz $ cd redis-2.6.14 $ make $ sudo make install CentOS 5自带的Tcl版本是8.4，Redis的make test需要用到Tcl 8.5以上的版本，如果你需要运行测试用例，请先安装新版本的Tcl，然后再安装Redis：
$ wget http://prdownloads.sourceforge.net/tcl/tcl8.6.0-src.tar.gz $ tar xzvf tcl8.6.0-src.tar.gz $ cd tcl8.6.0/unix $ ./configure $ make $ make test $ sudo make install 配置 Redis 服务 修复安装脚本 utils/install_server.sh 的问题 这个版本的安装脚本有一个小问题，请看 #909 Pull Request:
@@ -159,7 &#43;159,7 @@ REDIS_CHKCONFIG_INFO=\ # Description: Redis daemon\n ### END INIT INFO\n\n&#34; -if [ !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hoverruan.me/posts/2013/06/25/config-redis-replication-on-centos-5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-06-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2013-06-25T00:00:00+00:00" />

<meta itemprop="name" content="Config Redis Replication on Centos 5">
<meta itemprop="description" content="安装 Redis 2.6.14 CentOS 5.4 Redis 2.6.14 下载并安装：
$ wget http://redis.googlecode.com/files/redis-2.6.14.tar.gz $ cd redis-2.6.14 $ make $ sudo make install CentOS 5自带的Tcl版本是8.4，Redis的make test需要用到Tcl 8.5以上的版本，如果你需要运行测试用例，请先安装新版本的Tcl，然后再安装Redis：
$ wget http://prdownloads.sourceforge.net/tcl/tcl8.6.0-src.tar.gz $ tar xzvf tcl8.6.0-src.tar.gz $ cd tcl8.6.0/unix $ ./configure $ make $ make test $ sudo make install 配置 Redis 服务 修复安装脚本 utils/install_server.sh 的问题 这个版本的安装脚本有一个小问题，请看 #909 Pull Request:
@@ -159,7 &#43;159,7 @@ REDIS_CHKCONFIG_INFO=\ # Description: Redis daemon\n ### END INIT INFO\n\n&#34; -if [ !"><meta itemprop="datePublished" content="2013-06-25T00:00:00+00:00" />
<meta itemprop="dateModified" content="2013-06-25T00:00:00+00:00" />
<meta itemprop="wordCount" content="468">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Config Redis Replication on Centos 5"/>
<meta name="twitter:description" content="安装 Redis 2.6.14 CentOS 5.4 Redis 2.6.14 下载并安装：
$ wget http://redis.googlecode.com/files/redis-2.6.14.tar.gz $ cd redis-2.6.14 $ make $ sudo make install CentOS 5自带的Tcl版本是8.4，Redis的make test需要用到Tcl 8.5以上的版本，如果你需要运行测试用例，请先安装新版本的Tcl，然后再安装Redis：
$ wget http://prdownloads.sourceforge.net/tcl/tcl8.6.0-src.tar.gz $ tar xzvf tcl8.6.0-src.tar.gz $ cd tcl8.6.0/unix $ ./configure $ make $ make test $ sudo make install 配置 Redis 服务 修复安装脚本 utils/install_server.sh 的问题 这个版本的安装脚本有一个小问题，请看 #909 Pull Request:
@@ -159,7 &#43;159,7 @@ REDIS_CHKCONFIG_INFO=\ # Description: Redis daemon\n ### END INIT INFO\n\n&#34; -if [ !"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        HoverR&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Config Redis Replication on Centos 5</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2013-06-25T00:00:00Z">June 25, 2013</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id="安装-redis-2614">安装 Redis 2.6.14</h2>
<ul>
<li>CentOS 5.4</li>
<li>Redis 2.6.14</li>
</ul>
<p>下载并安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wget http://redis.googlecode.com/files/redis-2.6.14.tar.gz
</span></span><span style="display:flex;"><span>$ cd redis-2.6.14
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>$ sudo make install
</span></span></code></pre></div><p>CentOS 5自带的Tcl版本是8.4，Redis的<code>make test</code>需要用到Tcl 8.5以上的版本，如果你需要运行测试用例，请先安装新版本的Tcl，然后再安装Redis：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wget http://prdownloads.sourceforge.net/tcl/tcl8.6.0-src.tar.gz
</span></span><span style="display:flex;"><span>$ tar xzvf tcl8.6.0-src.tar.gz
</span></span><span style="display:flex;"><span>$ cd tcl8.6.0/unix
</span></span><span style="display:flex;"><span>$ ./configure
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>$ make test
</span></span><span style="display:flex;"><span>$ sudo make install
</span></span></code></pre></div><h2 id="配置-redis-服务">配置 Redis 服务</h2>
<h3 id="修复安装脚本-utilsinstall_serversh-的问题">修复安装脚本 utils/install_server.sh 的问题</h3>
<p>这个版本的安装脚本有一个小问题，请看 <a href="https://github.com/antirez/redis/pull/909">#909</a> Pull Request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#75715e">@@ -159,7 +159,7 @@ REDIS_CHKCONFIG_INFO=\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> # Description: Redis daemon\n
</span></span><span style="display:flex;"><span> ### END INIT INFO\n\n&#34;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">-if [ !`which chkconfig` ] ; then 
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+if [ ! `which chkconfig` ] ; then 
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>   #combine the header and the template (which is actually a static footer)
</span></span><span style="display:flex;"><span>   echo $REDIS_INIT_HEADER &gt; $TMP_FILE &amp;&amp; cat $INIT_TPL_FILE &gt;&gt; $TMP_FILE || die &#34;Could not write init script to $TMP_FILE&#34;
</span></span><span style="display:flex;"><span> else
</span></span><span style="display:flex;"><span><span style="color:#75715e">@@ -173,7 +173,7 @@ echo &#34;Copied $TMP_FILE =&gt; $INIT_SCRIPT_DEST&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span> #Install the service
</span></span><span style="display:flex;"><span> echo &#34;Installing service...&#34;
</span></span><span style="display:flex;"><span><span style="color:#f92672">-if [ !`which chkconfig` ] ; then 
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+if [ ! `which chkconfig` ] ; then 
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>   #if we&#39;re not a chkconfig box assume we&#39;re able to use update-rc.d
</span></span><span style="display:flex;"><span>   update-rc.d redis_$REDIS_PORT defaults &amp;&amp; echo &#34;Success!&#34;
</span></span><span style="display:flex;"><span> else
</span></span></code></pre></div><h3 id="修正sudo的时候的环境变量-path-的问题">修正sudo的时候的环境变量 $PATH 的问题</h3>
<p>默认的情况下，使用<code>sudo</code>命令时的<code>$PATH</code>环境变量只有<code>/usr/bin:/bin</code>两个路径，但是<code>install_server.sh</code>需要更多的路径：</p>
<ul>
<li><code>chkconfig</code>在<code>/sbin</code>目录下面</li>
<li><code>redis-server</code>和<code>redis-cli</code>默认安装在<code>/usr/local/bin</code>下面</li>
</ul>
<p>所以我们必须修改<code>sudo</code>命令时的环境变量。我喜欢使用的方式是做一个alias，修改<code>~/.bashrc</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>alias sudo<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sudo env PATH=/usr/bin:/bin:/sbin:/usr/sbin:/usr/local/bin&#39;</span>
</span></span></code></pre></div><p>重新登录以后就可以进行Redis服务的配置了！</p>
<h3 id="配置-master-slave-replication">配置 Master-Slave Replication</h3>
<p>首先配置两个Redis实例，分别使用端口<code>6379</code>和<code>6380</code>，把目录安装在<code>/data0/redis/6379</code>和<code>/data0/redis/6380</code>下面：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cd utils
</span></span><span style="display:flex;"><span>$ sudo ./install_server.sh
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Welcome to the redis service installer
</span></span><span style="display:flex;"><span>This script will help you easily set up a running redis server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis port <span style="color:#66d9ef">for</span> this instance: <span style="color:#f92672">[</span>6379<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Selecting default: <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis config file name <span style="color:#f92672">[</span>/etc/redis/6379.conf<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Selected default - /etc/redis/6379.conf
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis log file name <span style="color:#f92672">[</span>/var/log/redis_6379.log<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Selected default - /var/log/redis_6379.log
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the data directory <span style="color:#66d9ef">for</span> this instance <span style="color:#f92672">[</span>/var/lib/redis/6379<span style="color:#f92672">]</span> /data0/redis/6379
</span></span><span style="display:flex;"><span>Selected default - /var/lib/redis/6379
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis executable path <span style="color:#f92672">[</span>/usr/local/bin/redis-server<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>s#^port <span style="color:#f92672">[</span>0-9<span style="color:#f92672">]{</span>4<span style="color:#f92672">}</span>$#port 6379#;s#^logfile .+$#logfile /var/log/redis_6379.log#;s#^dir .+$#dir /var/lib/redis/6379#;s#^pidfile .+$#pidfile /var/run/redis_6379.pid#;s#^daemonize no$#daemonize yes#;
</span></span><span style="display:flex;"><span>Copied /tmp/6379.conf <span style="color:#f92672">=</span>&gt; /etc/init.d/redis_6379
</span></span><span style="display:flex;"><span>Installing service...
</span></span><span style="display:flex;"><span>Successfully added to chkconfig!
</span></span><span style="display:flex;"><span>Successfully added to runlevels 345!
</span></span><span style="display:flex;"><span>Starting Redis server...
</span></span><span style="display:flex;"><span>Installation successful!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo ./install_server.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Welcome to the redis service installer
</span></span><span style="display:flex;"><span>This script will help you easily set up a running redis server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis port <span style="color:#66d9ef">for</span> this instance: <span style="color:#f92672">[</span>6379<span style="color:#f92672">]</span> <span style="color:#ae81ff">6380</span>
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis config file name <span style="color:#f92672">[</span>/etc/redis/6380.conf<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Selected default - /etc/redis/6380.conf
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis log file name <span style="color:#f92672">[</span>/var/log/redis_6380.log<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Selected default - /var/log/redis_6380.log
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the data directory <span style="color:#66d9ef">for</span> this instance <span style="color:#f92672">[</span>/var/lib/redis/6380<span style="color:#f92672">]</span> /data0/redis/6380
</span></span><span style="display:flex;"><span>Selected default - /var/lib/redis/6380
</span></span><span style="display:flex;"><span>Please <span style="color:#66d9ef">select</span> the redis executable path <span style="color:#f92672">[</span>/usr/local/bin/redis-server<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>s#^port <span style="color:#f92672">[</span>0-9<span style="color:#f92672">]{</span>4<span style="color:#f92672">}</span>$#port 6380#;s#^logfile .+$#logfile /var/log/redis_6380.log#;s#^dir .+$#dir /var/lib/redis/6380#;s#^pidfile .+$#pidfile /var/run/redis_6380.pid#;s#^daemonize no$#daemonize yes#;
</span></span><span style="display:flex;"><span>Copied /tmp/6380.conf <span style="color:#f92672">=</span>&gt; /etc/init.d/redis_6380
</span></span><span style="display:flex;"><span>Installing service...
</span></span><span style="display:flex;"><span>Successfully added to chkconfig!
</span></span><span style="display:flex;"><span>Successfully added to runlevels 345!
</span></span><span style="display:flex;"><span>Starting Redis server...
</span></span><span style="display:flex;"><span>Installation successful!
</span></span></code></pre></div><p>加入我们把 6379 作为 Master，把 6380 作为 Slave，我们只需要修改<code>/etc/redis/6380.conf</code>：</p>
<pre tabindex="0"><code>slaveof 127.0.0.1 6379
</code></pre><p>重启Slave即可完成一个Master-Slave集群的配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo service redis_6380 stop
</span></span><span style="display:flex;"><span>$ sudo service redis_6380 start
</span></span></code></pre></div><h3 id="测试-master-slave-集群">测试 Master-Slave 集群</h3>
<p>首先，连接到 Master 并写入数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; set hover-name Ruan
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p>然后连接到 Slave 测试是否能读取到数据，并尝试在 Slave 写数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#ae81ff">6380</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6380&gt; get hover-name
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;Ruan&#34;</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6380&gt; set hover-name Hover
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>error<span style="color:#f92672">)</span> READONLY You can<span style="color:#960050;background-color:#1e0010">&#39;</span>t write against a read only slave.
</span></span></code></pre></div><p>OK，Master-Slave Replication 算是配置成功了！</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://hoverruan.me/" >
    &copy;  HoverR's Blog 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
